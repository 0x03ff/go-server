<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up</title>
    <link href="/assets/css/register.css" rel="stylesheet" type="text/css">
    <link rel="icon" href="/assets/image/storage_icon.ico">
</head>

<body>
    <div class="container">
        <h2>Registration</h2>

        <div id="error-message" class="error" style="display:none;"></div>

        <form id="register-form" method="POST">
            
            <label for="register_username">Please input user ID: 6-20 Characters:</label>
            <input type="text" id="username" name="username" placeholder="UserID" maxlength="20" required>

            <label for="password">Please input user password: 8-20 Characters</label><br>
            <input type="password" id="password" name="password" placeholder="Password" maxlength="20" required>

            <label for="confirm_password">Please input user password again: 8-20 Characters</label><br>
            <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm Password"
                maxlength="20" required>

            <label for="recover">Please input user recover key: 6-20 Characters</label><br>
            <input type="password" id="recover" name="recover" placeholder="Recover" maxlength="20" required>

            <label for="confirm_recover">Please input user recover key again: 6-20 Characters</label><br>
            <input type="password" id="confirm_recover" name="confirm_recover" placeholder="Confirm Password"
                maxlength="20" required>
            <input type="hidden" id="csrf_token" name="csrf_token" value="{{.CSRFToken}}">
            <button type="submit">Register</button>
        </form>

        <div class="link">
            <a href="/login">Already have an account? Sign in</a>
        </div>
    </div>

    <script type="module">
        import { generateECDHKeyPairP384, ECDH_hash256 } from '/assets/js/ECDH_384.js';
        import { checkCSRFToken } from '/assets/js/utils.js';

        document.addEventListener('DOMContentLoaded', function() {
            sessionStorage.clear();
            
            setTimeout(() => {
                checkCSRFToken();
                setInterval(checkCSRFToken, 30 * 1000);
            }, 100);
            
            const form = document.getElementById('register-form');
            const errorMessage = document.getElementById('error-message');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Clear previous errors
                errorMessage.style.display = 'none';
                errorMessage.textContent = '';
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm_password').value;
                const recover = document.getElementById('recover').value;
                const confirmRecover = document.getElementById('confirm_recover').value;
                const csrfToken = document.getElementById('csrf_token').value;

                // Client-side validation
                if (!validateForm(username, password, confirmPassword, recover, confirmRecover)) {
                    return;
                }

                try {
                    const hash_recover = await ECDH_hash256(recover);
                    const { publicKey: user_public_key, privateKey: user_encrypt_private_key } =
                        await generateECDHKeyPairP384(hash_recover);

                    const userData = {
                        "username": username,
                        "password": password,
                        "recover": recover,
                        "ecdh_public_key": btoa(user_public_key),
                        "ecdh_encrypt_private_key": user_encrypt_private_key
                    };
                   
                    const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken,
                        },
                        body: JSON.stringify(userData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        showError(errorData.error || 'Registration failed. Please try again.');
                        return;
                    }
                    
                    // Registration successful
                    alert('Registered successfully\nnow back to login page');
                    location.replace('/login');

                } catch (error) {
                    showError('Network error. Please check your connection and try again.');
                }
            });
            
            // Helper functions
            function validateForm(username, password, confirmPassword, recover, confirmRecover) {
                if (username.length < 6 || username.length > 20) {
                    showError('User ID must be 6-20 characters');
                    return false;
                }
                if (password.length < 8 || password.length > 20) {
                    showError('Password must be 8-20 characters');
                    return false;
                }
                if (password !== confirmPassword) {
                    showError('Passwords do not match');
                    return false;
                }
                if (recover.length < 6 || recover.length > 20) {
                    showError('Recovery key must be 6-20 characters');
                    return false;
                }
                if (recover !== confirmRecover) {
                    showError('Recovery keys do not match');
                    return false;
                }
                return true;
            }
            
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                errorMessage.scrollIntoView({ behavior: 'smooth' });
            }
        });
    </script>
</body>

</html>